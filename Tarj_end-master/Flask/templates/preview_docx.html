{% extends "base.html" %}

{% block title %}Página Inicial - STGC{% endblock %}

{% block content %}

        <div class="row justify-content-center">
            <section class="col-md-9">
                <div class="bg-white p-4 rounded-3 shadow-sm text-orange">
                    <h3 class="mb-3"><i class="bi bi-patch-check-fill text-success"></i> Documento Tarjado com Sucesso!
                    </h3>
                    <p class="text-muted">Abaixo está a pré-visualização do seu documento com as tarjas aplicadas. Você
                        pode ajustar as tarjas antes de baixar.</p>
                    <hr>

                    <!-- Início do formulário de revisão de tarjamento -->
                    <form method="POST" action="{{ url_for('aplicar_tarjas_docx') }}" class="text-start">

                        <h4 class="mb-3">Dados encontrados:</h4>
                        <div class="mb-4">
                              <!-- Checkbox Mestre -->
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkAll" checked>
                            <label class="form-check-label fw-bold" for="checkAll">Selecionar/Desmarcar todos</label>
                        </div>
                            {% for item in ocorrencias %}
                            <div class="form-check">
                                <input class="form-check-input item-checkbox" type="checkbox" name="selecionados"
                                    value="{{ item.id }}" id="item{{ item.id }}" checked>
                                <label class="form-check-label" for="item{{ item.id }}">
                                    [{{ item.tipo }}] "{{ item.texto }}" no parágrafo {{ item.paragrafo + 1 }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <h4 class="mb-2">Texto Original:</h4>
                        <div class="border p-3 rounded bg-light" style="max-height: 400px; overflow-y: auto;">

                       <!-- Campo oculto para trechos manuais -->
                        <input type="hidden" name="tarjas_manualmente_adicionadas" id="manualTarjasHidden">

                        <!-- Container para preview dinâmico -->
                        <div id="previewConteudo" class="border p-3 rounded bg-light" style="max-height: 400px; overflow-y: auto;">
                            {% for p in paragrafos %}
                                <p>{{ p }}</p>
                            {% endfor %}
                        </div>

                        <!-- Botão que adiciona o texto selecionado -->
                        <button type="button" class="btn btn-outline-secondary my-2" onclick="adicionarSelecaoComoTarja()">➕ Adicionar Seleção como Tarja</button>

                     <div class="d-flex justify-content-center align-items-center mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-shield-fill-x me-2"></i>Aplicar Tarjas e Fazer Download
                        </button>

                            <a href="{{ url_for('tarjar_docx_preview') }}" class="btn btn-secondary btn-lg">
                               <i class="bi bi-house-door-fill me-2"></i> Cancelar Solicitação
                            </a>
                        </div>
                        <script>
                        let tarjasManuais = [];

                        function adicionarSelecaoComoTarja() {
                            const selecionado = window.getSelection().toString().trim();
                            if (selecionado.length === 0) {
                                alert("Selecione um trecho de texto com o mouse para adicionar como tarja.");
                                return;
                            }
                            tarjasManuais.push(selecionado);
                            document.getElementById("manualTarjasHidden").value = tarjasManuais.join("|");
                            alert(`Trecho selecionado "${selecionado}" adicionado para tarjamento.`);
                            atualizarPreview();
                        }

                        async function atualizarPreview() {
                            const selecionados = Array.from(document.querySelectorAll('input[name="selecionados"]:checked')).map(i => i.value);
                            const manuaisRaw = document.getElementById('manualTarjasHidden').value;
                            const manuais = manuaisRaw.split('|').map(t => t.trim()).filter(t => t.length > 0);

                            try {
                                const resp = await fetch('/atualizar_preview_docx', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({selecionados, manuais})
                                });

                                if (!resp.ok) {
                                    const text = await resp.text();
                                    console.error('Erro na resposta:', text);
                                    alert('Erro ao atualizar preview');
                                    return;
                                }

                                const data = await resp.json();

                                if (data.erro) {
                                    console.error('Erro do servidor:', data.erro);
                                    alert('Erro ao atualizar preview: ' + data.erro);
                                    return;
                                }

                                const container = document.getElementById('previewConteudo');
                                container.innerHTML = '';
                                data.paragrafos.forEach(texto => {
                                    const p = document.createElement('p');
                                    p.textContent = texto;
                                    container.appendChild(p);
                                });
                            } catch (e) {
                                console.error('Erro na requisição:', e);
                                alert('Erro inesperado ao atualizar preview');
                            }
                        }

                    </script>

                    </form>
                </div>
            </section>
        </div>
{% endblock %}