{% extends "base.html" %}

{% block title %}Pré-visualização PDF OCR Tarjado{% endblock %}

{% block content %}
    <div class="row justify-content-center">
      <section class="col-md-10">
       <div class="bg-white p-4 rounded-3 shadow-sm">
        <h3 class="mb-3"><i class="bi bi-patch-check-fill text-success"></i> Documento Tarjado com Sucesso!</h3>
        <p class="text-muted">Abaixo está a pré-visualização do seu documento com as tarjas aplicadas. Você pode ajustar as tarjas antes de baixar.</p>
        <hr>

        <!-- PDF embutido com OCR -->
        <div class="border rounded-3 mb-4" style="height: 700px;">
          <embed src="{{ url_for('ver_pdf_ocr') }}" type="application/pdf" width="100%" height="100%" style="border: none;" />
        </div>

        <!-- Início do formulário -->
        <form method="post" action="{{ url_for('aplicar_tarjas_ocr_pdf') }}">
          <!-- Campo oculto para trechos manuais -->
        <input type="hidden" name="tarjas_manuais_json" id="manualTarjasHidden">

          <!-- Campo para adicionar tarjas manuais -->
          <div class="mb-3">
            <label for="trechoManual" class="form-label">Inserir trecho manual:</label>
            <div class="input-group">
              <input type="text" id="trechoManual" class="form-control" placeholder="Cole aqui o trecho que deseja ocultar" autocomplete="off">
              <button type="button" class="btn btn-outline-secondary" onclick="adicionarTarjaManual()">➕ Adicionar</button>
            </div>
            <small class="form-text text-muted">Você pode adicionar vários trechos, um de cada vez.</small>
          </div>
            <!-- Campo para texto de tarja manual, fora do loop -->
 
          <!-- Lista visual dos trechos manuais -->
          <ul id="listaTarjas" class="list-group mb-4"></ul>

          <!-- Dados detectados -->
          <h4 class="mb-3">Dados encontrados automaticamente:</h4>
          <div class="mb-4">
            <p><strong>{{ ocorrencias|length }}</strong> ocorrência(s) sensível(is) detectada(s).</p>

            <!-- Checkbox Mestre -->
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="checkAll" checked>
              <label class="form-check-label fw-bold" for="checkAll">Selecionar/Desmarcar todos</label>
            </div>

            <!-- Lista de ocorrências -->
            {% for item in ocorrencias %}
            <div class="form-check">
              <input class="form-check-input item-checkbox" type="checkbox" name="selecionados" value="{{ item.id }}" id="chk{{ loop.index }}" checked>
              <label class="form-check-label" for="chk{{ loop.index }}">
                {{ item.tipo }}: "{{ item.texto }}" (Página {{ item.pagina + 1 }})
              </label>
            </div>
            {% endfor %}
          </div>
          <hr>

          <!-- Botões -->
            <div class="d-flex justify-content-center align-items-center mt-4">
             <button type="submit" class="btn btn-primary">
                <i class="bi bi-shield-fill-x me-2"></i>Aplicar Tarjas e Fazer Download
            </button>

            <a href="{{ url_for('tarjar_ocr_pdf') }}" class="btn btn-secondary"> Cancelar Solicitação</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Script para adicionar e visualizar tarjas manuais -->
   <script>
    let tarjasManuais = [];
    let idCounter = 10000;

    function adicionarTarjaManual() {
      const input = document.getElementById("trechoManual");
      const valor = input.value.trim();
      if (valor.length === 0) {
        alert("Insira um trecho antes de adicionar.");
        return;
      }

      const novaTarja = { id: idCounter++, pagina: 0, trecho: valor };
      tarjasManuais.push(novaTarja);

      document.getElementById("manualTarjasHidden").value = JSON.stringify(tarjasManuais);

      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.textContent = valor;

      const btnRemover = document.createElement("button");
      btnRemover.textContent = "Remover";
      btnRemover.className = "btn btn-sm btn-outline-danger ms-2";
      btnRemover.onclick = function () {
        tarjasManuais = tarjasManuais.filter(t => t.id !== novaTarja.id);
        document.getElementById("manualTarjasHidden").value = JSON.stringify(tarjasManuais);
        li.remove();
        atualizarPreviewOCR();
      };

      li.appendChild(btnRemover);
      document.getElementById("listaTarjas").appendChild(li);

      input.value = "";
      atualizarPreviewOCR();
    }

    document.getElementById("checkAll").addEventListener("change", function () {
      const checkboxes = document.querySelectorAll(".item-checkbox");
      checkboxes.forEach(cb => cb.checked = this.checked);
      atualizarPreviewOCR();
    });

    document.querySelectorAll(".item-checkbox").forEach(cb => {
      cb.addEventListener("change", atualizarPreviewOCR);
    });

    async function atualizarPreviewOCR() {
      const selecionados = Array.from(document.querySelectorAll('input[name="selecionados"]:checked')).map(i => i.value);
      const manuais = tarjasManuais;

      try {
        const resp = await fetch('/atualizar_preview_ocr_pdf', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({selecionados, manuais})
        });

        if (!resp.ok) {
          alert('Erro ao atualizar preview OCR');
          return;
        }

        const data = await resp.json();
        if (data.erro) {
          alert('Erro: ' + data.erro);
          return;
        }

        // Atualiza embed do PDF OCR com base64 retornado
        const embed = document.querySelector('embed[type="application/pdf"]');
        embed.src = 'data:application/pdf;base64,' + data.pdf_data;

      } catch (e) {
        alert('Erro inesperado ao atualizar preview OCR');
        console.error(e);
      }
    }

    window.addEventListener('load', atualizarPreviewOCR);
</script>

{% endblock %}
